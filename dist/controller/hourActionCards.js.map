{"version":3,"sources":["../../src/controller/hourActionCards.js"],"names":["createHourActionCards","data","getYesterday","dataYesterday","today","Date","start","thisDate","find","dateString","actions","findOne","_id","idDashboard","dashboard","listBack","listInpr","listComp","len","length","dataHour","dataBack","dataInpr","dataComp","i","j","d","date","hour","getHours","type","indexOf","list","id","countBack","countInpr","countComp","listAfter","listBefore","card","closed","old","allData","timeHour","hourActionCards","push","createnewHourActionCards","callHourActionCards","getHourActionCards","DateActionCards","setDate","getDate","yesterday","dateActionCards","split","year","month","day","join","dateY","HourActionCards","create","newHourActionCards","update","$set"],"mappings":";;;;;;;;;;;;;;;;;;;AAAA;;AACA;;AACA;;AACA;;AACA;;;;AAEO,IAAMA;AAAA,0EAAwB,iBAAMC,IAAN;AAAA;;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,+BACLC,+CAA6BD,IAA7B,CADK;;AAAA;AAC3BE,qCAD2B;AAE7BC,6BAF6B,GAErB,IAAIC,IAAJ,CAASJ,KAAKK,KAAd,CAFqB;AAAA;AAAA,+BAGZ,gCAAaF,KAAb,CAHY;;AAAA;AAG7BG,gCAH6B;AAAA;AAAA,+BAIV,iBAAQC,IAAR,CAAa,EAACC,YAAYF,QAAb,EAAb,CAJU;;AAAA;AAI3BG,+BAJ2B;AAAA;AAAA,+BAKT,uBAAWC,OAAX,CAAmB,EAACC,KAAKX,KAAKY,WAAX,EAAnB,CALS;;AAAA;AAK3BC,iCAL2B;;AAAA,4BAM7BA,SAN6B;AAAA;AAAA;AAAA;;AAAA,yDAOtB,6BAPsB;;AAAA;AAQ3BC,gCAR2B,GAQhBD,UAAUC,QARM;AAS3BC,gCAT2B,GAShBF,UAAUE,QATM;AAU3BC,gCAV2B,GAUhBH,UAAUG,QAVM;AAW3BC,2BAX2B,GAWrBR,QAAQS,MAXa;AAa7BC,gCAb6B,GAalB,EAbkB;AAc7BC,gCAd6B,GAclB,EAdkB;AAe7BC,gCAf6B,GAelB,EAfkB;AAgB7BC,gCAhB6B,GAgBlB,EAhBkB;AAkBxBC,yBAlBwB,GAkBpB,CAlBoB;;AAAA;AAAA,8BAkBjBA,KAAK,EAlBY;AAAA;AAAA;AAAA;;AAmB7B,6BAASC,CAAT,GAAa,CAAb,EAAgBA,IAAIP,GAApB,EAAyBO,GAAzB,EAA6B;AACnBxB,iCADmB,GACZS,QAAQe,CAAR,EAAWxB,IADC;AAErByB,6BAFqB,GAEjB,IAAIrB,IAAJ,CAASK,QAAQe,CAAR,EAAWE,IAApB,CAFiB;AAGrBC,gCAHqB,GAGbF,EAAEG,QAAF,EAHa;;AAIzB,gCAAGL,KAAGI,IAAN,EAAW;AACP,oCAAGlB,QAAQe,CAAR,EAAWK,IAAX,IAAiB,YAAjB,IAAiCpB,QAAQe,CAAR,EAAWK,IAAX,IAAiB,iBAAlD,IAAuEpB,QAAQe,CAAR,EAAWK,IAAX,IAAkB,UAAzF,IAAuGpB,QAAQe,CAAR,EAAWK,IAAX,IAAkB,4BAA5H,EAAyJ;AACrJ,wCAAIf,SAASgB,OAAT,CAAiB9B,MAAK+B,IAAL,CAAUC,EAA3B,KAAkC,CAAC,CAAvC,EAA0C9B,cAAc+B,SAAd,GAA1C,KACK,IAAIlB,SAASe,OAAT,CAAiB9B,MAAK+B,IAAL,CAAUC,EAA3B,KAAkC,CAAC,CAAvC,EAA0C9B,cAAcgC,SAAd,GAA1C,KACA,IAAIlB,SAASc,OAAT,CAAiB9B,MAAK+B,IAAL,CAAUC,EAA3B,KAAkC,CAAC,CAAvC,EAA0C9B,cAAciC,SAAd;AAClD,iCAJD,MAKK,IAAG1B,QAAQe,CAAR,EAAWK,IAAX,IAAiB,YAAjB,IAAiC7B,MAAKoC,SAAtC,IAAmDpC,MAAKqC,UAA3D,EAAsE;AACvE,wCAAIvB,SAASgB,OAAT,CAAiB9B,MAAKoC,SAAL,CAAeJ,EAAhC,KAAuC,CAAC,CAA5C,EAA+C9B,cAAc+B,SAAd,GAA/C,KACK,IAAIlB,SAASe,OAAT,CAAiB9B,MAAKoC,SAAL,CAAeJ,EAAhC,KAAuC,CAAC,CAA5C,EAA+C9B,cAAcgC,SAAd,GAA/C,KACA,IAAIlB,SAASc,OAAT,CAAiB9B,MAAKoC,SAAL,CAAeJ,EAAhC,KAAuC,CAAC,CAA5C,EAA+C9B,cAAciC,SAAd;;AAEpD,wCAAIrB,SAASgB,OAAT,CAAiB9B,MAAKqC,UAAL,CAAgBL,EAAjC,KAAwC,CAAC,CAA7C,EAAgD9B,cAAc+B,SAAd,GAAhD,KACK,IAAIlB,SAASe,OAAT,CAAiB9B,MAAKqC,UAAL,CAAgBL,EAAjC,KAAwC,CAAC,CAA7C,EAAgD9B,cAAcgC,SAAd,GAAhD,KACA,IAAIlB,SAASc,OAAT,CAAiB9B,MAAKqC,UAAL,CAAgBL,EAAjC,KAAwC,CAAC,CAA7C,EAAgD9B,cAAciC,SAAd;AACxD,iCARI,MASA,IAAG1B,QAAQe,CAAR,EAAWK,IAAX,IAAiB,YAAjB,IAAiC7B,MAAKsC,IAAL,CAAUC,MAAV,IAAoB,KAArD,IAA8DvC,MAAKwC,GAAL,CAASD,MAAT,IAAmB,IAApF,EAAyF;AAC1F,wCAAIzB,SAASgB,OAAT,CAAiB9B,MAAK+B,IAAL,CAAUC,EAA3B,KAAkC,CAAC,CAAvC,EAA0CC,YAA1C,KACK,IAAIlB,SAASe,OAAT,CAAiB9B,MAAK+B,IAAL,CAAUC,EAA3B,KAAkC,CAAC,CAAvC,EAA0CE,YAA1C,KACA,IAAIlB,SAASc,OAAT,CAAiB9B,MAAK+B,IAAL,CAAUC,EAA3B,KAAkC,CAAC,CAAvC,EAA0CG;AAClD,iCAJI,MAKA,IAAG1B,QAAQe,CAAR,EAAWK,IAAX,IAAiB,YAAjB,IAAiC7B,MAAKsC,IAAL,CAAUC,MAAV,IAAoB,IAArD,IAA6DvC,MAAKwC,GAAL,CAASD,MAAT,IAAmB,KAAnF,EAAyF;AAC1F,wCAAIzB,SAASgB,OAAT,CAAiB9B,MAAK+B,IAAL,CAAUC,EAA3B,KAAkC,CAAC,CAAvC,EAA0CC,YAA1C,KACK,IAAIlB,SAASe,OAAT,CAAiB9B,MAAK+B,IAAL,CAAUC,EAA3B,KAAkC,CAAC,CAAvC,EAA0CE,YAA1C,KACA,IAAIlB,SAASc,OAAT,CAAiB9B,MAAK+B,IAAL,CAAUC,EAA3B,KAAkC,CAAC,CAAvC,EAA0CG;AAClD;AACJ;AACJ;AACKM,+BAlDuB,GAkDb;AACZjC,wCAAYF,QADA;AAEZoC,sCAAUnB,CAFE;AAGZU,uCAAW/B,cAAc+B,SAHb;AAIZC,uCAAWhC,cAAcgC,SAJb;AAKZC,uCAAWjC,cAAciC,SALb;AAMZvB,yCAAaC,UAAUF;AANX,yBAlDa;AAAA;AAAA,+BA0DC,iCAAgBD,OAAhB,CAAwB;AAClDF,wCAAYiC,QAAQjC,UAD8B;AAElDkC,sCAAUD,QAAQC,QAFgC;AAGlD9B,yCAAa6B,QAAQ7B;AAH6B,yBAAxB,CA1DD;;AAAA;AA0DvB+B,uCA1DuB;;AA+D7BxB,iCAASyB,IAAT,CAAcrB,CAAd;AACAH,iCAASwB,IAAT,CAAcH,QAAQR,SAAtB;AACAZ,iCAASuB,IAAT,CAAcH,QAAQP,SAAtB;AACAZ,iCAASsB,IAAT,CAAcH,QAAQN,SAAtB;;AAlE6B;AAAA,+BAoEKU,2DAAyCJ,OAAzC,EAAiDE,eAAjD,CApEL;;AAAA;AAoEvBG,2CApEuB;;AAAA;AAkBRvB,2BAlBQ;AAAA;AAAA;;AAAA;AAsE3BwB,0CAtE2B,GAsEN;AACvB5B,sCAAUA,QADa;AAEvBC,sCAAUA,QAFa;AAGvBC,sCAAUA,QAHa;AAIvBC,sCAAUA;AAJa,yBAtEM;AAAA,yDA4E1ByB,kBA5E0B;;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,KAAxB;;AAAA;AAAA;AAAA;AAAA,GAAN;;AA+EA,IAAM9C;AAAA,2EAAe,kBAAO+C,eAAP,EAAuBhD,IAAvB;AAAA;;AAAA;AAAA;AAAA;AAAA;AACpByB,yBADoB,GAChB,IAAIrB,IAAJ,CAASJ,KAAKK,KAAd,CADgB;;AAExBoB,0BAAEwB,OAAF,CAAUxB,EAAEyB,OAAF,KAAc,CAAxB;AAFwB;AAAA,+BAGF,gCAAazB,CAAb,CAHE;;AAAA;AAGpB0B,iCAHoB;AAAA;AAAA,+BAIIH,gBAAgBtC,OAAhB,CAAwB,EAAEF,YAAY2C,SAAd,EAAyBvC,aAAaZ,KAAKY,WAA3C,EAAxB,CAJJ;;AAAA;AAIpBwC,uCAJoB;;AAKxB,4BAAG,CAACA,eAAJ,EAAoB;AAAA,+CACeD,UAAUE,KAAV,CAAgB,GAAhB,CADf,yEACXC,IADW,yBACLC,KADK,yBACE7B,IADF,yBACQ8B,GADR;;AAEhBL,wCAAY,CAACG,IAAD,EAAOC,KAAP,EAAc7B,IAAd,EAAoB+B,IAApB,CAAyB,GAAzB,CAAZ;AACIC,iCAHY,GAGJ,IAAItD,IAAJ,CAAS+C,SAAT,CAHI;;AAIhBC,8CAAkB;AACd1B,sCAAMgC,KADQ;AAEdlD,4CAAY2C,SAFE;AAGdlB,2CAAW,CAHG;AAIdC,2CAAW,CAJG;AAKdC,2CAAW,CALG;AAMdvB,6CAAaZ,KAAKY;AANJ,6BAAlB;AAQH;AAjBuB,0DAkBjBwC,eAlBiB;;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,KAAf;;AAAA;AAAA;AAAA;AAAA,GAAN;;AAqBA,IAAMP;AAAA,2EAA2B,kBAAOc,eAAP,EAAuBlB,OAAvB,EAA+BE,eAA/B;AAAA;;AAAA;AAAA;AAAA;AAAA;AAAA,4BAC/BA,eAD+B;AAAA;AAAA;AAAA;;AAAA;AAAA,+BAECgB,gBAAgBC,MAAhB,CAAuBnB,OAAvB,CAFD;;AAAA;AAE1BoB,0CAF0B;AAAA,0DAGzBA,kBAHyB;;AAAA;AAAA,8BAK3BpB,QAAQR,SAAR,IAAqBU,gBAAgBV,SAArC,IAAkDQ,QAAQP,SAAR,IAAqBS,gBAAgBT,SAAvF,IAAoGO,QAAQN,SAAR,IAAqBQ,gBAAgBR,SAL9G;AAAA;AAAA;AAAA;;AAAA;AAAA,+BAMCwB,gBAAgBG,MAAhB,CAAuB,EAACnD,KAAKgC,gBAAgBhC,GAAtB,EAAvB,EAAkD,EAACoD,MAAK;AACrF9B,2CAAWQ,QAAQR,SADkE;AAErFC,2CAAWO,QAAQP,SAFkE;AAGrFC,2CAAWM,QAAQN;AAHkE,6BAAN,EAAlD,CAND;;AAAA;AAM1B0B,2CAN0B;AAAA,0DAWzBA,mBAXyB;;AAAA;AAAA,0DAczB,KAdyB;;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,KAA3B;;AAAA;AAAA;AAAA;AAAA,GAAN","file":"hourActionCards.js","sourcesContent":["import {HourActionCards} from '../models/hourActionCards'\nimport {Actions} from '../models/actions'\nimport {Dashboards} from '../models/dashboards'\nimport {DateActionCards} from '../models/dateActionCards'\nimport {convertDates} from './convertDates'\n\nexport const createHourActionCards = async(data) => {\n    const dataYesterday = await getYesterday(DateActionCards,data)\n    let today = new Date(data.start)\n    let thisDate = await convertDates(today)\n    const actions =  await Actions.find({dateString: thisDate})\n    const dashboard = await Dashboards.findOne({_id: data.idDashboard})\n    if(!dashboard)\n        return \"Error!! Not found dashboard\"\n    const listBack = dashboard.listBack\n    const listInpr = dashboard.listInpr\n    const listComp = dashboard.listComp\n    const len = actions.length\n\n    let dataHour = []\n    let dataBack = []\n    let dataInpr = []\n    let dataComp = []\n\n    for (let i = 0; i <= 23; i++) {\n        for (let j = 0; j < len; j++){\n            const data = actions[j].data\n            let d = new Date(actions[j].date)\n            let hour = (d.getHours())\n            if(i==hour){\n                if(actions[j].type==\"createCard\" || actions[j].type==\"moveCardToBoard\" || actions[j].type== \"copyCard\" || actions[j].type== \"convertToCardFromCheckItem\"){\n                    if (listBack.indexOf(data.list.id) != -1) dataYesterday.countBack++\n                    else if (listInpr.indexOf(data.list.id) != -1) dataYesterday.countInpr++\n                    else if (listComp.indexOf(data.list.id) != -1) dataYesterday.countComp++\n                }\n                else if(actions[j].type==\"updateCard\" && data.listAfter && data.listBefore){\n                    if (listBack.indexOf(data.listAfter.id) != -1) dataYesterday.countBack++\n                    else if (listInpr.indexOf(data.listAfter.id) != -1) dataYesterday.countInpr++\n                    else if (listComp.indexOf(data.listAfter.id) != -1) dataYesterday.countComp++\n    \n                    if (listBack.indexOf(data.listBefore.id) != -1) dataYesterday.countBack--\n                    else if (listInpr.indexOf(data.listBefore.id) != -1) dataYesterday.countInpr--\n                    else if (listComp.indexOf(data.listBefore.id) != -1) dataYesterday.countComp--\n                }\n                else if(actions[j].type==\"updateCard\" && data.card.closed == false && data.old.closed == true){ \n                    if (listBack.indexOf(data.list.id) != -1) countBack++\n                    else if (listInpr.indexOf(data.list.id) != -1) countInpr++\n                    else if (listComp.indexOf(data.list.id) != -1) countComp++\n                }\n                else if(actions[j].type==\"updateCard\" && data.card.closed == true && data.old.closed == false){ \n                    if (listBack.indexOf(data.list.id) != -1) countBack--\n                    else if (listInpr.indexOf(data.list.id) != -1) countInpr--\n                    else if (listComp.indexOf(data.list.id) != -1) countComp--\n                }\n            }   \n        }\n        const allData = {\n            dateString: thisDate,\n            timeHour: i,\n            countBack: dataYesterday.countBack,\n            countInpr: dataYesterday.countInpr,\n            countComp: dataYesterday.countComp,\n            idDashboard: dashboard._id\n        }\n        const hourActionCards = await HourActionCards.findOne({ \n            dateString: allData.dateString, \n            timeHour: allData.timeHour,\n            idDashboard: allData.idDashboard\n        })\n        dataHour.push(i)\n        dataBack.push(allData.countBack)\n        dataInpr.push(allData.countInpr)\n        dataComp.push(allData.countComp)\n\n        const callHourActionCards = await createnewHourActionCards(HourActionCards,allData,hourActionCards)\n    }\n    const getHourActionCards = {\n        dataHour: dataHour,\n        dataBack: dataBack,\n        dataInpr: dataInpr,\n        dataComp: dataComp\n    }\n    return getHourActionCards\n}\n\nexport const getYesterday = async (DateActionCards,data) => {\n    let d = new Date(data.start)\n    d.setDate(d.getDate() - 1)\n    let yesterday = await convertDates(d)\n    let dateActionCards = await DateActionCards.findOne({ dateString: yesterday, idDashboard: data.idDashboard})\n    if(!dateActionCards){\n        let [year, month, date, day] = yesterday.split('-')\n        yesterday = [year, month, date].join('-')\n        let dateY = new Date(yesterday)\n        dateActionCards = {\n            date: dateY,\n            dateString: yesterday,\n            countBack: 0,\n            countInpr: 0,\n            countComp: 0,\n            idDashboard: data.idDashboard\n        }\n    }\n    return dateActionCards\n}\n\nexport const createnewHourActionCards = async (HourActionCards,allData,hourActionCards) => {\n    if (!hourActionCards) {\n        const newHourActionCards = await HourActionCards.create(allData)\n        return newHourActionCards\n    }\n    else if (allData.countBack != hourActionCards.countBack || allData.countInpr != hourActionCards.countInpr || allData.countComp != hourActionCards.countComp ) {\n        const newHourActionCards = await HourActionCards.update({_id: hourActionCards._id},{$set:{\n            countBack: allData.countBack,\n            countInpr: allData.countInpr,\n            countComp: allData.countComp\n        }})\n        return newHourActionCards\n    } \n    else\n        return false\n}"]}