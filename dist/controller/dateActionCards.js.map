{"version":3,"sources":["../../src/controller/dateActionCards.js"],"names":["createDateActionCards","dateStart","dashboard","now","Date","countBack","countInpr","countComp","find","idDashboard","_id","findDateAction","lenFind","length","date","setDate","getDate","d","ymd","dateString","sort","dataThisDay","len","listBack","listInpr","listComp","dateAction","i","data","type","indexOf","list","id","listAfter","listBefore","card","closed","old","allData","findOne","dateActionCards","createnewDateActionCards","callDateActionCards","DateActionCards","create","newDateActionCards","update","$set"],"mappings":"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","file":"dateActionCards.js","sourcesContent":["import {DateActionCards} from '../models/dateActionCards'\nimport {Actions} from '../models/actions'\nimport {convertDates} from './convertDates'\n\nexport const createDateActionCards = async(dateStart,dashboard) => {\n    const now = new Date()\n    let countBack = 0 \n    let countInpr = 0\n    let countComp = 0\n    const findDateAction = await DateActionCards.find({idDashboard:dashboard._id})\n    const lenFind = findDateAction.length\n    if(lenFind>2){\n        dateStart = new Date(findDateAction[lenFind-2].date)\n        countBack = findDateAction[lenFind-3].countBack\n        countInpr = findDateAction[lenFind-3].countInpr\n        countComp = findDateAction[lenFind-3].countComp\n    }\n    now.setDate(now.getDate() + 1)\n    for (let d = new Date(dateStart); d <= now; d.setDate(d.getDate() + 1)) {\n        const ymd = await convertDates(d)\n        const dataThisDay =  await Actions.find({dateString: ymd}).sort({date:1})\n        const len = dataThisDay.length\n        const listBack = dashboard.listBack\n        const listInpr = dashboard.listInpr\n        const listComp = dashboard.listComp\n        let dateAction = d\n        for(let i=0;i<len;i++){\n            const data = dataThisDay[i].data\n            if(dataThisDay[i].type==\"createCard\" || dataThisDay[i].type==\"moveCardToBoard\"|| dataThisDay[i].type== \"copyCard\" || dataThisDay[i].type== \"convertToCardFromCheckItem\"||dataThisDay[i].type==\"emailCard\"){\n                if (listBack.indexOf(data.list.id) != -1) countBack++\n                else if (listInpr.indexOf(data.list.id) != -1) countInpr++\n                else if (listComp.indexOf(data.list.id) != -1) countComp++\n                dateAction = dataThisDay[i].date\n            }\n            else if(dataThisDay[i].type==\"updateCard\" && data.listAfter && data.listBefore){\n                if (listBack.indexOf(data.listAfter.id) != -1) countBack++\n                else if (listInpr.indexOf(data.listAfter.id) != -1) countInpr++\n                else if (listComp.indexOf(data.listAfter.id) != -1) countComp++\n                \n                if (listBack.indexOf(data.listBefore.id) != -1) countBack--\n                else if (listInpr.indexOf(data.listBefore.id) != -1) countInpr--\n                else if (listComp.indexOf(data.listBefore.id) != -1) countComp--\n                dateAction = dataThisDay[i].date\n            }\n            else if(dataThisDay[i].type==\"updateCard\" && data.card.closed == false && data.old.closed == true){ \n                if (listBack.indexOf(data.list.id) != -1) countBack++\n                else if (listInpr.indexOf(data.list.id) != -1) countInpr++\n                else if (listComp.indexOf(data.list.id) != -1) countComp++\n                dateAction = dataThisDay[i].date\n            }\n            else if(dataThisDay[i].type==\"updateCard\" && data.card.closed == true && data.old.closed == false){ \n                if (listBack.indexOf(data.list.id) != -1) countBack--\n                else if (listInpr.indexOf(data.list.id) != -1) countInpr--\n                else if (listComp.indexOf(data.list.id) != -1) countComp--\n                dateAction = dataThisDay[i].date\n            }\n            else if(dataThisDay[i].type==\"moveCardFromBoard\"){ \n                if (listBack.indexOf(data.list.id) != -1) countBack--\n                else if (listInpr.indexOf(data.list.id) != -1) countInpr--\n                else if (listComp.indexOf(data.list.id) != -1) countComp--\n                dateAction = dataThisDay[i].date\n            }\n        }\n        const allData = {\n            date: dateAction,\n            dateString: ymd,\n            countBack: countBack,\n            countInpr: countInpr,\n            countComp: countComp,\n            idDashboard: dashboard._id\n        }\n        const dateActionCards = await DateActionCards.findOne({ dateString: allData.dateString, idDashboard: allData.idDashboard})\n        const callDateActionCards = await createnewDateActionCards(DateActionCards,allData,dateActionCards)\n    }\n}\n\nexport const createnewDateActionCards = async (DateActionCards,allData,dateActionCards) => {\n    if (!dateActionCards) {\n        const newDateActionCards = await DateActionCards.create(allData)\n        return newDateActionCards\n    }\n    else if (allData.countBack != dateActionCards.countBack || allData.countInpr != dateActionCards.countInpr || allData.countComp != dateActionCards.countComp ) {\n        const newDateActionCards = await DateActionCards.update({_id: dateActionCards._id},{$set:{\n            countBack: allData.countBack,\n            countInpr: allData.countInpr,\n            countComp: allData.countComp\n        }})\n        return newDateActionCards\n    } \n    else\n        return false\n}\n\n"]}