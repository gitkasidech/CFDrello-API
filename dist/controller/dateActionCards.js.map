{"version":3,"sources":["../../src/controller/dateActionCards.js"],"names":["createDateActionCards","dateStart","dashboard","now","Date","countBack","countInpr","countComp","d","ymd","find","dateString","dataThisDay","len","length","listBack","listInpr","listComp","dateAction","i","data","type","indexOf","list","id","date","listAfter","listBefore","card","closed","old","allData","idDashboard","_id","findOne","dateActionCards","createnewDateActionCards","callDateActionCards","setDate","getDate","DateActionCards","create","newDateActionCards","update","$set"],"mappings":"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","file":"dateActionCards.js","sourcesContent":["import {DateActionCards} from '../models/dateActionCards'\r\nimport {Actions} from '../models/actions'\r\nimport {convertDates} from './convertDates'\r\n\r\nexport const createDateActionCards = async(dateStart,dashboard) => {\r\n    const now = new Date()\r\n    let countBack = 0 \r\n    let countInpr = 0\r\n    let countComp = 0\r\n    for (let d = new Date(dateStart); d <= now; d.setDate(d.getDate() + 1)) {\r\n        const ymd = await convertDates(d)\r\n        const dataThisDay =  await Actions.find({dateString: ymd})\r\n        const len = dataThisDay.length\r\n        const listBack = dashboard.listBack\r\n        const listInpr = dashboard.listInpr\r\n        const listComp = dashboard.listComp\r\n        let dateAction = d\r\n        for(let i=0;i<len;i++){\r\n            const data = dataThisDay[i].data\r\n            if(dataThisDay[i].type==\"createCard\" || dataThisDay[i].type==\"moveCardToBoard\" ){\r\n                if (listBack.indexOf(data.list.id) != -1) countBack++\r\n                else if (listInpr.indexOf(data.list.id) != -1) countInpr++\r\n                else if (listComp.indexOf(data.list.id) != -1) countComp++\r\n                dateAction = dataThisDay[i].date\r\n            }\r\n            else if(dataThisDay[i].type==\"updateCard\" && data.listAfter && data.listBefore){\r\n                if (listBack.indexOf(data.listAfter.id) != -1) countBack++\r\n                else if (listInpr.indexOf(data.listAfter.id) != -1) countInpr++\r\n                else if (listComp.indexOf(data.listAfter.id) != -1) countComp++\r\n                \r\n                if (listBack.indexOf(data.listBefore.id) != -1) countBack--\r\n                else if (listInpr.indexOf(data.listBefore.id) != -1) countInpr--\r\n                else if (listComp.indexOf(data.listBefore.id) != -1) countComp--\r\n                dateAction = dataThisDay[i].date\r\n            }\r\n            else if(dataThisDay[i].type==\"updateCard\" && data.card.closed == false && data.old.closed == true){ \r\n                if (listBack.indexOf(data.list.id) != -1) countBack++\r\n                else if (listInpr.indexOf(data.list.id) != -1) countInpr++\r\n                else if (listComp.indexOf(data.list.id) != -1) countComp++\r\n                dateAction = dataThisDay[i].date\r\n            }\r\n            else if(dataThisDay[i].type==\"updateCard\" && data.card.closed == true && data.old.closed == false){ \r\n                if (listBack.indexOf(data.list.id) != -1) countBack--\r\n                else if (listInpr.indexOf(data.list.id) != -1) countInpr--\r\n                else if (listComp.indexOf(data.list.id) != -1) countComp--\r\n                dateAction = dataThisDay[i].date\r\n            }\r\n        }\r\n        const allData = {\r\n            date: dateAction,\r\n            dateString: ymd,\r\n            countBack: countBack,\r\n            countInpr: countInpr,\r\n            countComp: countComp,\r\n            idDashboard: dashboard._id\r\n        }\r\n        const dateActionCards = await DateActionCards.findOne({ dateString: allData.dateString, idDashboard: allData.idDashboard})\r\n        const callDateActionCards = await createnewDateActionCards(DateActionCards,allData,dateActionCards)\r\n        // if (callDateActionCards)\r\n        //     console.log(\"create or update new DateActionCards complete\")\r\n        // else\r\n        //     console.log(\"have a DateActionCards already!!\")\r\n    }\r\n}\r\n\r\nexport const createnewDateActionCards = async (DateActionCards,allData,dateActionCards) => {\r\n    if (!dateActionCards) {\r\n        const newDateActionCards = await DateActionCards.create(allData)\r\n        return newDateActionCards\r\n    }\r\n    else if (allData.countBack != dateActionCards.countBack || allData.countInpr != dateActionCards.countInpr || allData.countComp != dateActionCards.countComp ) {\r\n        const newDateActionCards = await DateActionCards.update({_id: dateActionCards._id},{$set:{\r\n            countBack: allData.countBack,\r\n            countInpr: allData.countInpr,\r\n            countComp: allData.countComp\r\n        }})\r\n        return newDateActionCards\r\n    } \r\n    else\r\n        return false\r\n}\r\n\r\n"]}